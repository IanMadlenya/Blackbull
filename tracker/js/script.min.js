(function(k){var n=false;var h=false;var l=null;var e=k("#porttableholder");var p=k("#trans_scrip");var r=k("#autoresults");var c=k("#trans_qscrip");var j=k("#trans_price");var o=k("#foliosummary").attr("rel");var q=k("#container").attr("class");var b=k("#managecasha");var g=k("#addtransa");var f=k("#cashfrmholder");var d=k("#formslide");var m=k("#formholder");var a=false;k(":date").dateinput({format:"yyyy-mm-dd"});k.getJSON("/serverscripts/portfolio/getTrades.php?portfolio="+o+"&user="+q,function(s){trades_html="";scrip_symbols="";invested_value=0;for(count=0;count<s.total;count++){trades_html+='<div class="bodydiv clearfix" id="'+s.data[count].scrip_symbol.replace(".","_")+'">';trades_html+='<div class="first"><a href="http://blackbull.in/finance/overview?bbid='+q+"&pfid="+o+"&trid="+s.data[count].trade_id+'">';trades_html+=s.data[count].scrip_name+'</a><div class="subrow clearfix"><span class="symbolname">'+s.data[count].scrip_symbol+"</span></div></div>";trades_html+='<div class="ltp"><div class="ltpval">'+s.data[count][0]+"</div>";if(s.data[count][1]<0){trades_html+='<div class="pchange negative">'+s.data[count][1]+"</div></div>"}else{trades_html+='<div class="pchange">'+s.data[count][1]+"</div></div>"}trades_html+='<div class="avgbuy">'+s.data[count].trade_avg_buy+"</div>";trades_html+='<div class="tradeqty">'+s.data[count].trade_qty+"</div>";if(s.data[count][2]<0){trades_html+='<div class="profitloss negative">'+s.data[count][2]+"</div></div>"}else{trades_html+='<div class="profitloss">'+s.data[count][2]+"</div></div>"}scrip_symbols=scrip_symbols+s.data[count].scrip_symbol+"+";invested_value+=(s.data[count].trade_avg_buy*s.data[count].trade_qty)}k("#cashvalue").html(sprintf("%.1f",parseFloat(s.cash)));k("#marketvalue").html(sprintf("%.1f",invested_value));e.append(trades_html);e.attr("data-symbols",scrip_symbols);k(".bodydiv").slideDown("slow");getLTP(e);getIndices()});p.blur(function(){if(a==false){r.addClass("hidden");r.html("")}});p.keyup(function(s){if(!(s.which>=16&&s.which<=18)&&!(s.which>=112&&s.which<=123)&&s.which!=27){if(p.val().length>=3){if(l){l.abort();l=null}r.removeClass("hidden");r.html("loading...");l=k.getJSON("/serverscripts/symbollookup.php?scrip="+p.val(),function(t){r.html("");html="";for(i=0;i<t.ResultSet.Result.length;i++){if((t.ResultSet.Result[i].symbol.toUpperCase().indexOf(".BO")!=-1||t.ResultSet.Result[i].symbol.toUpperCase().indexOf(".NS")!=-1)&&(t.ResultSet.Result[i].symbol.toUpperCase().indexOf("_A.")==-1)&&(t.ResultSet.Result[i].name.toUpperCase().indexOf("FUTURE")==-1)){html+='<div class="result_item clearfix">';html+='<div class="scrip_name" data-name="'+t.ResultSet.Result[i].symbol+'" data-qname="'+t.ResultSet.Result[i].name+'">';html+=t.ResultSet.Result[i].name;html+="</div>";html+='<div class="scrip_symbol">';html+=t.ResultSet.Result[i].symbol;html+="</div>";html+='<div class="scrip_xchange">';html+=t.ResultSet.Result[i].exch;html+="</div>";html+="</div>"}}if(html==""){html="Symbol not found."}r.html(html);r.hover(function(){a=true},function(){a=false});k(".result_item").hover(function(){k(this).css("backgroundColor","#FFF9B8")},function(){k(this).css("backgroundColor","#fff")});k(".result_item").click(function(){p.val(k(this).children(".scrip_name").attr("data-name"));c.val(k(this).children(".scrip_name").attr("data-qname"));r.addClass("hidden");r.html("")})})}else{r.addClass("hidden");r.html("")}}});k("#cmpa").click(function(s){s.preventDefault();if(p.val().length>=3){j.addClass("gettingprice");j.val("Retrieving price...");k.getJSON("/serverscripts/portfolio/getPrice.php?scrip="+p.val(),function(t){if(t.value!=0){j.val(t.value)}else{j.val("")}j.removeClass("gettingprice")})}});g.click(function(s){s.preventDefault();if(b.hasClass("activetab")){b.removeClass("activetab")}if(!b.hasClass("inactivetab")){b.addClass("inactivetab")}if(f.hasClass("open")){f.removeClass("open");f.hide();d.addClass("open");d.show();if(k(this).hasClass("inactivetab")){k(this).removeClass("inactivetab")}if(!k(this).hasClass("activetab")){k(this).addClass("activetab")}return true}if(d.hasClass("open")){d.removeClass("open");d.slideUp("slow");m.removeClass("grayed");if(k(this).hasClass("activetab")){k(this).removeClass("activetab")}if(k(this).hasClass("inactivetab")){k(this).removeClass("inactivetab")}if(b.hasClass("inactivetab")){b.removeClass("inactivetab")}return true}if(!k(this).hasClass("activetab")){k(this).addClass("activetab")}d.addClass("open");d.slideDown("slow");m.addClass("grayed")});b.click(function(s){s.preventDefault();if(g.hasClass("activetab")){g.removeClass("activetab")}if(!g.hasClass("inactivetab")){g.addClass("inactivetab")}if(d.hasClass("open")){d.removeClass("open");d.hide();f.addClass("open");f.show();if(k(this).hasClass("inactivetab")){k(this).removeClass("inactivetab")}if(!k(this).hasClass("activetab")){k(this).addClass("activetab")}return true}if(f.hasClass("open")){f.removeClass("open");f.slideUp("slow");m.removeClass("grayed");if(k(this).hasClass("activetab")){k(this).removeClass("activetab")}if(k(this).hasClass("inactivetab")){k(this).removeClass("inactivetab")}if(g.hasClass("inactivetab")){g.removeClass("inactivetab")}return true}if(!k(this).hasClass("activetab")){k(this).addClass("activetab")}f.addClass("open");f.slideDown("slow");m.addClass("grayed")});k("#submitbtn").click(function(s){s.preventDefault();k.ajax({type:"POST",url:"/serverscripts/portfolio/addTransaction.php",data:({csrf:k("#csrf").val(),portfolio_id:o,user_id:k.trim(k("#user_id").val()),trans_scrip:k.trim(p.val()),trans_qscrip:k.trim(c.val()),trans_type:k.trim(k("#trans_type").val()),includecash:k("#includecash").attr("checked")?1:0,trans_date:k.trim(k("#trans_date").val()),trans_price:k.trim(j.val()),trans_qty:k.trim(k("#trans_qty").val()),stoploss:k.trim(k("#stoploss").val()),trans_notes:k.trim(k("#trans_notes").val())}),dataType:"json",beforeSend:function(){if(n){return false}else{n=true;if(!k("#resulttxt").hasClass("hidden")){k("#resulttxt").addClass("hidden")}if(k("#resulttxt").hasClass("red")){k("#resulttxt").removeClass("red")}k("#resulttxt").html("Please wait&hellip;");if(k("#resulttxt").hasClass("hidden")){k("#resulttxt").removeClass("hidden")}return true}},success:function(u){if(k("#resulttxt").hasClass("hidden")){k("#resulttxt").removeClass("hidden")}if(u.status=="1"){k("#resulttxt").html("Transaction added successfully!");if(u.new_trade=="1"){var t='<div class="bodydiv clearfix" id="'+p.val().replace(".","_")+'"><div class="first"';t+='<a href="http://blackbull.in/finance/overview?user=1&symbol='+p.val()+'">';t+=u.qname+'</a><div class="subrow clearfix"><span class="symbolname">'+p.val()+"</span></div></div>";t+='<div class="ltp"><div class="ltpval">'+u.ltp+"</div>";if(u.stockchg<0){t+='<div class="pchange negative">'+u.stockchg+"</div></div>"}else{t+='<div class="pchange">'+u.stockchg+"</div></div>"}t+='<div class="avgbuy">'+u.avg_buy+"</div>";t+='<div class="tradeqty">'+u.trade_qty+"</div>";t+='<div class="profitloss">loading&hellip;</div></div>';scrip_symbols=e.attr("data-symbols");scrip_symbols=scrip_symbols+p.val()+"+";e.attr("data-symbols",scrip_symbols);e.append(t);k("#"+p.val().replace(".","_")).slideDown("slow");market_value=parseFloat(k("#marketvalue").html())+parseFloat(u.avg_buy*u.trade_qty);k("#marketvalue").html(market_value)}else{var v="#"+p.val().replace(".","_");k(v+" .avgbuy").html(u.avg_buy);k(v+" .tradeqty").html(u.trade_qty);k(v+" .profitloss").html("loading&hellip;")}document.getElementById("addtrsnsform").reset()}else{if(!k("#resulttxt").hasClass("red")){k("#resulttxt").addClass("red")}k("#resulttxt").html(u.error)}n=false;setTimeout(function(){if(!k("#resulttxt").hasClass("hidden")){k("#resulttxt").addClass("hidden")}},5000)},error:function(){n=false}})});k("#cashsubmitbtn").click(function(s){s.preventDefault();k.ajax({type:"POST",url:"/serverscripts/portfolio/managecash.php",data:({csrf:k("#cashcsrf").val(),portfolio_id:o,amount:k.trim(k("#cashinrs").val()),cash_type:k.trim(k("#cash_type").val()),cash_date:k.trim(k("#cash_date").val()),cash_notes:k.trim(k("#cash_notes").val())}),beforeSend:function(){if(h){return false}else{h=true;if(!k("#cashresulttxt").hasClass("hidden")){k("#cashresulttxt").addClass("hidden")}if(k("#cashresulttxt").hasClass("red")){k("#cashresulttxt").removeClass("red")}k("#cashresulttxt").html("Please wait&hellip;");if(k("#cashresulttxt").hasClass("hidden")){k("#cashresulttxt").removeClass("hidden")}return true}},success:function(t){h=false;if(k("#cashresulttxt").hasClass("hidden")){k("#cashresulttxt").removeClass("hidden")}if(t.status=="1"){k("#cashresulttxt").html(t.message);totalcash=parseFloat(k("#cashvalue").html())+t.cash;k("#cashvalue").html(sprintf("%.1f",totalcash));document.getElementById("managecashform").reset()}else{if(!k("#cashresulttxt").hasClass("red")){k("#cashresulttxt").addClass("red")}k("#cashresulttxt").html(t.error)}setTimeout(function(){if(!k("#cashresulttxt").hasClass("hidden")){k("#cashresulttxt").addClass("hidden")}},5000)},error:function(){h=false}})})})(this.jQuery);function getLTP(b){scrips=b.attr("data-symbols");var a=$("#container").attr("class");ureturns=0;net_value=0;if(scrips.length>0){$.getJSON("/serverscripts/portfolio/getLTP.php?user="+a+"&scrips="+scrips,function(f){for(count=0;count<f.total;count++){scripsymbol="#"+f.data[count].symbol.replace(".","_");$(scripsymbol+" .ltpval").html(f.data[count].ltp);$(scripsymbol+" .pchange").html(f.data[count].change);if(f.data[count].change<0){if(!$(scripsymbol+" .pchange").hasClass("negative")){$(scripsymbol+" .pchange").addClass("negative")}}else{if($(scripsymbol+" .pchange").hasClass("negative")){$(scripsymbol+" .pchange").removeClass("negative")}}var c=$(scripsymbol+" .avgbuy").html();var g=$(scripsymbol+" .tradeqty").html();var e=f.data[count].ltp;var d=((parseFloat(e)-parseFloat(c))*parseInt(g));ureturns+=d;net_value+=(f.data[count].ltp*g);$(scripsymbol+" .profitloss").html(sprintf("%.1f",d));if(d<0){if(!$(scripsymbol+" .profitloss").hasClass("negative")){$(scripsymbol+" .profitloss").addClass("negative")}}else{if($(scripsymbol+" .profitloss").hasClass("negative")){$(scripsymbol+" .profitloss").removeClass("negative")}}}$("#ureturn").html(sprintf("%.1f",ureturns));$("#netvalue").html(sprintf("%.1f",net_value));setTimeout(function(){getLTP(b)},10000)})}else{setTimeout(function(){getLTP(b)},10000)}}function getIndices(){$.getJSON("/serverscripts/getindices.php",function(a){if(a.error=="0"){if(parseFloat(a.values[0].change)<0){}else{}$("#nifty .indexvalue").html(a.values[0].price);$("#nifty .indexchange").html(a.values[0].change+" / "+a.values[0].perchange);if(parseFloat(a.values[1].change)<0){}else{}$("#sensex .indexvalue").html(a.values[1].price);$("#sensex .indexchange").html(a.values[1].change+" / "+a.values[1].perchange)}setTimeout(getIndices,10000)})};